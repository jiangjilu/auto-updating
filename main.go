// Code generated by hertz generator.

package main

import (
	"context"
	"fmt"
	"github.com/cloudwego/hertz/pkg/app/client"
	"github.com/cloudwego/hertz/pkg/app/server"
	"github.com/cloudwego/hertz/pkg/protocol"
	"github.com/jiangjilu/auto-updating/biz/dal"
	"github.com/jiangjilu/auto-updating/biz/mw"
	"github.com/robfig/cron/v3"
	"math/rand"
	"sync"
	"time"
)

var wg sync.WaitGroup

const charset = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789"

func generateRandomString() string {
	rand.Seed(time.Now().UnixNano())
	length := rand.Intn(20) + 1 // 生成1-20的随机数
	result := make([]byte, length)
	for i := range result {
		result[i] = charset[rand.Intn(len(charset))]
	}
	return string(result)
}

func createNewsArticle() {
	// Logic to create a new news article goes here.
	fmt.Println("\nCreating a new news article..." + time.Now().String())

	c, err := client.NewClient()
	if err != nil {
		return
	}

	// Post request
	var postArgs protocol.Args

	//获取当前时间的年月日时分秒格式字符串
	timeString := time.Now().Format("2006年01月02 15点04分05秒")
	//设置分类ID为随机1-5
	postArgs.Set("cid", fmt.Sprintf("%d", time.Now().UnixNano()%5+1))
	postArgs.Set("title", "标题 "+timeString)
	postArgs.Set("content", "资讯内容 "+timeString)
	//设置状态 随机数 0-2
	postArgs.Set("status", fmt.Sprintf("%d", time.Now().UnixNano()%3))

	//1
	randomString := generateRandomString()
	postArgs.Set("title", randomString+"标题 "+timeString)
	randomString = generateRandomString()
	postArgs.Set("content", randomString+"资讯内容 "+timeString)
	status, body, _ := c.Post(context.Background(), nil, "http://localhost:9090/v1/news/create", &postArgs)

	//循环10次
	for i := 0; i < 20; i++ {
		randomString = generateRandomString()
		postArgs.Set("title", randomString+"标题 "+timeString)
		randomString = generateRandomString()
		postArgs.Set("content", randomString+"资讯内容 "+timeString)
		status, body, _ = c.Post(context.Background(), nil, "http://localhost:9090/v1/news/create", &postArgs)
	}

	fmt.Printf("status=%v body=%v\n", status, string(body))
}

func doCronRequest() {
	c := cron.New(cron.WithSeconds())
	//每分钟执行1次
	//_, err := c.AddFunc("1 * * * * *", createNewsArticle)
	//每秒执行1次
	_, err := c.AddFunc("* * * * * *", createNewsArticle)
	if err != nil {
		fmt.Println("Error scheduling job: ", err)
		return
	}
	c.Start()
}

func main() {
	wg.Add(2)

	// 开启 HTTP Web 服务
	go func() {
		defer wg.Done()

		dal.Init()

		port := ":9090"
		h := server.Default(
			server.WithHostPorts(port),
			// 修改html/templates模板后，自动重新渲染html无需重启服务
			server.WithAutoReloadRender(true, 0),
		)

		h.Use(mw.Cms(h))

		register(h)

		fmt.Printf("\n\n欢迎使用 auto-updating.com\nhttp://127.0.0.1%s\n\n", port)

		h.Spin()
	}()

	// 自动化任务
	go func() {
		defer wg.Done()

		time.Sleep(time.Millisecond * 50)
		doCronRequest()
	}()

	wg.Wait()
}
